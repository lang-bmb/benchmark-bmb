// fasta - DNA sequence generation benchmark
// Benchmarks Game algorithm with LCG random
// Uses fixed-point arithmetic (1000000 scale factor)
// v0.52: StringBuilder + tail recursion for O(n) performance

// Helper: print string with newline (println takes i64, not String)
fn printline(s: String) -> i64 = { let _u = println_str(s); 0 };

// LCG constants
fn im() -> i64 = 139968;
fn ia() -> i64 = 3877;
fn ic() -> i64 = 29573;
fn line_width() -> i64 = 60;

// Fixed-point scale (for probabilities)
fn scale() -> i64 = 1000000;

// Random number as fixed-point (0 to scale)
fn random_scaled(seed: i64) -> i64 = (seed * scale()) / im();

// IUB nucleotide cumulative probabilities (scaled)
fn iub_prob(idx: i64) -> i64 =
    if idx == 0 { 270000 }       -- a: 0.27
    else if idx == 1 { 390000 }   -- c: 0.12 (cumulative)
    else if idx == 2 { 510000 }   -- g: 0.12
    else if idx == 3 { 780000 }   -- t: 0.27
    else if idx == 4 { 800000 }   -- B: 0.02
    else if idx == 5 { 820000 }   -- D: 0.02
    else if idx == 6 { 840000 }   -- H: 0.02
    else if idx == 7 { 860000 }   -- K: 0.02
    else if idx == 8 { 880000 }   -- M: 0.02
    else if idx == 9 { 900000 }   -- N: 0.02
    else if idx == 10 { 920000 }  -- R: 0.02
    else if idx == 11 { 940000 }  -- S: 0.02
    else if idx == 12 { 960000 }  -- V: 0.02
    else if idx == 13 { 980000 }  -- W: 0.02
    else { 1000000 };             -- Y: 0.02

// IUB nucleotide char codes (ASCII)
fn iub_char_code(idx: i64) -> i64 =
    if idx == 0 { 97 }   -- 'a'
    else if idx == 1 { 99 }   -- 'c'
    else if idx == 2 { 103 }  -- 'g'
    else if idx == 3 { 116 }  -- 't'
    else if idx == 4 { 66 }   -- 'B'
    else if idx == 5 { 68 }   -- 'D'
    else if idx == 6 { 72 }   -- 'H'
    else if idx == 7 { 75 }   -- 'K'
    else if idx == 8 { 77 }   -- 'M'
    else if idx == 9 { 78 }   -- 'N'
    else if idx == 10 { 82 }  -- 'R'
    else if idx == 11 { 83 }  -- 'S'
    else if idx == 12 { 86 }  -- 'V'
    else if idx == 13 { 87 }  -- 'W'
    else { 89 };              -- 'Y'

fn iub_len() -> i64 = 15;

// Homo sapiens cumulative probabilities (scaled)
fn homo_prob(idx: i64) -> i64 =
    if idx == 0 { 302955 }        -- a: 0.3029549426680
    else if idx == 1 { 500943 }   -- c: 0.1979883004921
    else if idx == 2 { 698491 }   -- g: 0.1975473066391
    else { 1000000 };             -- t: 0.3015094502008

fn homo_char_code(idx: i64) -> i64 =
    if idx == 0 { 97 }   -- 'a'
    else if idx == 1 { 99 }   -- 'c'
    else if idx == 2 { 103 }  -- 'g'
    else { 116 };             -- 't'

fn homo_len() -> i64 = 4;

// Select nucleotide based on random value (returns char code) - iterative
fn select_iub_iter(r: i64, idx: i64) -> i64 =
    if idx >= iub_len() - 1 or r < iub_prob(idx) { iub_char_code(idx) }
    else { select_iub_iter(r, idx + 1) };

fn select_iub_code(r: i64) -> i64 = select_iub_iter(r, 0);

fn select_homo_iter(r: i64, idx: i64) -> i64 =
    if idx >= homo_len() - 1 or r < homo_prob(idx) { homo_char_code(idx) }
    else { select_homo_iter(r, idx + 1) };

fn select_homo_code(r: i64) -> i64 = select_homo_iter(r, 0);

// ALU sequence
fn alu() -> String = "GGCCGGGCGCGGTGGCTCACGCCTGTAATCCCAGCACTTTGGGAGGCCGAGGCGGGCGGATCACCTGAGGTCAGGAGTTCGAGACCAGCCTGGCCAACATGGTGAAACCCCGTCTCTACTAAAAATACAAAAATTAGCCGGGCGTGGTGGCGCGCGCCTGTAATCCCAGCTACTCGGGAGGCTGAGGCAGGAGAATCGCTTGAACCCGGGAGGCGGAGGTTGCAGTGAGCCGAGATCGCGCCACTGCACTCCAGCCTGGGCGACAGAGCGAGACTCCGTCTCAAAAA";

fn alu_len() -> i64 = 287;

// Build one line of repeat sequence into StringBuilder
fn build_repeat_line(sb: i64, alu_str: String, k: i64, count: i64, limit: i64) -> i64 =
    if count >= limit { k }
    else {
        let pos = k % alu_len();
        let c = alu_str.byte_at(pos);
        let _u = sb_push_char(sb, c);
        build_repeat_line(sb, alu_str, k + 1, count + 1, limit)
    };

// Generate repeat sequence lines
fn print_repeat_lines(alu_str: String, k: i64, remaining: i64) -> i64 =
    if remaining <= 0 { k }
    else {
        let sb = sb_new();
        let chars_to_write = if remaining < line_width() { remaining } else { line_width() };
        let new_k = build_repeat_line(sb, alu_str, k, 0, chars_to_write);
        let line = sb_build(sb);
        let _u = printline(line);
        print_repeat_lines(alu_str, new_k, remaining - chars_to_write)
    };

fn print_repeat(n: i64) -> i64 = {
    let _u0 = printline(">ONE Homo sapiens alu");
    print_repeat_lines(alu(), 0, n)
};

// Build one line of random IUB sequence into StringBuilder
fn build_iub_line(sb: i64, seed: i64, count: i64, limit: i64) -> i64 =
    if count >= limit { seed }
    else {
        let new_seed = (seed * ia() + ic()) % im();
        let r = random_scaled(new_seed);
        let c = select_iub_code(r);
        let _u = sb_push_char(sb, c);
        build_iub_line(sb, new_seed, count + 1, limit)
    };

// Generate random IUB sequence lines
fn print_iub_lines(seed: i64, remaining: i64) -> i64 =
    if remaining <= 0 { seed }
    else {
        let sb = sb_new();
        let chars_to_write = if remaining < line_width() { remaining } else { line_width() };
        let new_seed = build_iub_line(sb, seed, 0, chars_to_write);
        let line = sb_build(sb);
        let _u = printline(line);
        print_iub_lines(new_seed, remaining - chars_to_write)
    };

fn print_random_iub(seed: i64, n: i64) -> i64 = {
    let _u0 = printline(">TWO IUB ambiguity codes");
    print_iub_lines(seed, n)
};

// Build one line of random homo sequence into StringBuilder
fn build_homo_line(sb: i64, seed: i64, count: i64, limit: i64) -> i64 =
    if count >= limit { seed }
    else {
        let new_seed = (seed * ia() + ic()) % im();
        let r = random_scaled(new_seed);
        let c = select_homo_code(r);
        let _u = sb_push_char(sb, c);
        build_homo_line(sb, new_seed, count + 1, limit)
    };

// Generate random homo sequence lines
fn print_homo_lines(seed: i64, remaining: i64) -> i64 =
    if remaining <= 0 { seed }
    else {
        let sb = sb_new();
        let chars_to_write = if remaining < line_width() { remaining } else { line_width() };
        let new_seed = build_homo_line(sb, seed, 0, chars_to_write);
        let line = sb_build(sb);
        let _u = printline(line);
        print_homo_lines(new_seed, remaining - chars_to_write)
    };

fn print_random_homo(seed: i64, n: i64) -> i64 = {
    let _u0 = printline(">THREE Homo sapiens frequency");
    print_homo_lines(seed, n)
};

fn main() -> i64 = {
    let n = 1000;  -- FAIR VERSION v0.51.5: same as C (was 100)
    let _u1 = print_repeat(n * 2);
    let seed1 = print_random_iub(42, n * 3);
    let _seed2 = print_random_homo(seed1, n * 5);
    0
};
